<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Member Dashboard</title>
    <link rel="stylesheet" href="../css/member.css" />
    <!-- bootstrap cdn -->
    <!-- Latest compiled and minified CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
      crossorigin="anonymous"
    />

    <!-- Optional theme -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap-theme.min.css"
      integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
      crossorigin="anonymous"
    />

    <!-- Latest compiled and minified JavaScript -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"
      integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
      crossorigin="anonymous"
    ></script>
    <script>
      // Check if the user is logged in
      function checkLogin() {
        // get cookie named accessToken and role value
        let accessToken = document.cookie.split(';')[1].split('=')[1];
        let role = document.cookie.split(';')[0].split('=')[1];
        console.log(accessToken, role)
        if (!accessToken || !role) {
          // Redirect to the login page
          window.location.href = "./login.html";
        }else if (role !== "member") {
          // Redirect to the login page
          window.location.href = "./login.html";
        }
      }
      checkLogin();
    </script>
  </head>
  <body>
    <div class="dashboard__container">
      <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">
            <img
              src="../assests//bootstrap-logo.svg"
              alt=""
              width="30"
              height="24"
              class="d-inline-block align-text-top"
            />
          </a>
        </div>
      </nav>
      <!-- books -->
      <div class="container">
        <div class="mt-4 d-flex justify-content-between">
          <h3>Books Data</h3>
          <button
            type="button"
            class="btn btn-outline-primary"
            data-bs-toggle="modal"
            data-bs-target="#addBook"
          >
            Add Book
          </button>
        </div>
        <!-- add book modal -->
        <div
          class="modal fade"
          id="addBook"
          tabindex="-1"
          aria-labelledby="addBook"
          aria-hidden="true"
        >
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="addBook">Add a book</h1>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <form>
                  <div class="mb-3">
                    <label for="book-id" class="col-form-label">Book Id:</label>
                    <input type="text" class="form-control" id="book-id" />
                  </div>
                  <div class="mb-3">
                    <label for="book-name" class="col-form-label"
                      >Book Name:</label
                    >
                    <input type="text" class="form-control" id="book-name" />
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  onclick="addbook()"
                >
                  Save
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- list of books -->
        <div class="row">
          <div class="col-md-12">
            <table class="table table-striped" id="books-data">
              <thead>
                <tr>
                  <th>Book ID</th>
                  <th>Book Name</th>
                  <th>Book Status</th>
                  <th>Update</th>
                  <th>delete</th>
                </tr>
              </thead>
              <tbody>
                <!-- Table body content will be generated dynamically -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- update book modal -->
        <div
          class="modal fade"
          id="updateBook"
          tabindex="-1"
          aria-labelledby="updateBook"
          aria-hidden="true"
        >
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="updateBook_heading">
                  Update book
                </h1>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <form>
                  <div class="mb-3">
                    <label for="book-id" class="col-form-label">Book Id:</label>
                    <input
                      type="text"
                      class="form-control"
                      id="update-book-id"
                      value=""
                    />
                  </div>
                  <div class="mb-3">
                    <label for="book-name" class="col-form-label"
                      >Book Name:</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="update-book-name"
                      value=""
                    />
                  </div>
                  <div class="mb-3">
                    <label for="book-status" class="col-form-label"
                      >Book available:</label
                    >
                    <input
                      type="checkbox"
                      name="update-book-status"
                      id="update-book-status"
                    />
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  onclick="updateSpecificBook()"
                >
                  Save
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
  </body>
  <script>
    // get the access token and role from cookie
    let accessToken = document.cookie.split(";")[1].split("=")[1];
    let role = document.cookie.split(";")[0].split("=")[1];
    (() => {
      fetch("http://localhost:3000/librarian", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${accessToken}`,
        },
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.status === 200) {
            if (data.books.length === 0) {
              return (document.querySelector(
                "#books-data tbody"
              ).innerHTML = `<tr><td colspan="4" class="text-center">No books found</td></tr>`);
            }

            // Get the table body element
            const tableBody = document.querySelector("#books-data tbody");

            // Generate table rows dynamically based on the data
            data.books.forEach((item) => {
              const row = document.createElement("tr");
              row.innerHTML = `<td>${item.bookId}</td>
                              <td>${item.bookName}</td>
                              <td>${item.bookStatus}</td>
                              <td><button type="button" class="btn btn-outline-success update-button" data-bs-toggle="modal" data-bs-target="#updateBook" data-id="${item._id}">Update</button></td>
                              <td><button type="button" class="btn btn-outline-danger delete-button" data-id="${item._id}">Delete</button></td>`;
              tableBody.appendChild(row);
            });

            if (data.members.length === 0) {
              return (document.querySelector(
                "#members-data tbody"
              ).innerHTML = `<tr><td colspan="4" class="text-center">No members found</td></tr>`);
            }

            // Get the table body element
            const tableBodyMembers = document.querySelector(
              "#members-data tbody"
            );

            // Generate table rows dynamically based on the data
            data.members.forEach((item) => {
              const row = document.createElement("tr");
              row.innerHTML = `<td>${item.username}</td>
                              <td>${item.password}</td>
                              <td><button type="button" class="btn btn-outline-success members-update-button" data-bs-toggle="modal" data-bs-target="#updateMembers" data-id="${item._id}">Update</button></td>
                              <td><button type="button" class="btn btn-outline-danger members-delete-button" data-id="${item._id}">Delete</button></td>`;
              tableBodyMembers.appendChild(row);
            });
          }
          // Add click event listeners to the update buttons and delete buttons
          const updateButtons = document.querySelectorAll(".update-button");
          updateButtons.forEach((button) => {
            button.addEventListener("click", () => {
              const id = button.dataset.id;
              // Call the update function with the ID
              updateBook(id, data.books);
            });
          });
          const deleteButtons = document.querySelectorAll(".delete-button");
          deleteButtons.forEach((button) => {
            button.addEventListener("click", () => {
              const id = button.dataset.id;
              // Call the update function with the ID
              deleteBook(id, data.books);
            });
          });

          const updateButtonsMembers = document.querySelectorAll(
            ".members-update-button"
          );
          updateButtonsMembers.forEach((button) => {
            button.addEventListener("click", () => {
              const id = button.dataset.id;
              // Call the update function with the ID
              updateMembers(id, data.members);
            });
          });
          const deleteButtonsMembers = document.querySelectorAll(
            ".members-delete-button"
          );
          deleteButtonsMembers.forEach((button) => {
            button.addEventListener("click", () => {
              const id = button.dataset.id;
              // Call the update function with the ID
              deleteMembers(id, data.members);
            });
          });
        })
        .catch((err) => console.log(err));
    })();
  </script>
</html>
